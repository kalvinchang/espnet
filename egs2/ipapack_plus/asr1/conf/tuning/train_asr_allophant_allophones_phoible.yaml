seed: 11711
freeze_param: [
  "frontend.encoder.feature_extractor"
]

frontend: huggingface
frontend_conf:
    model: "facebook/wav2vec2-xls-r-300m"
    download_dir: ./hub

normalize: null

encoder: allophant
encoder_conf:
    phoneme_embedding_size: 640
    # Blank offset 2 to handle <unk> token from Stage 5
    blank_offset: 2
    # <sos/eos> token from Stage 5
    additional_special_tokens: 1
    feature_type: phoible
    use_allophone_layer: true
    phoneme_inventory_file: data/token_list/word/tokens_mapped.txt
    phoible_path: local/allophoible/allophoible_v2.csv
    composition_inventories_file: dump/raw/train_allophant/inventories.json
    composition_features:
      - advancedTongueRoot
      - anterior
      - approximant
      - back
      - click
      - consonantal
      - constrictedGlottis
      - continuant
      - coronal
      - delayedRelease
      - distributed
      - dorsal
      - epilaryngealSource
      - fortis
      - front
      - high
      - labial
      - labiodental
      - lateral
      - low
      - loweredLarynxImplosive
      - nasal
      - periodicGlottalSource
      - raisedLarynxEjective
      - retractedTongueRoot
      - round
      - short
      - sonorant
      - spreadGlottis
      - stress
      - strident
      - syllabic
      - tap
      - tense
      - trill
      - long
    language_id_mapping_path: dump/raw/train_allophant/supported_languages.json
    utt_id_separator: "_"
    allophone_identity_placeholders:
      - bel
      - bos
      - cym
      - kaz
      - mal
      - mar
      - nya
      - ori
      - orm
      - srp
      - tgk
      - urd
      - uzb
      - bak
      - ina
      - kmr
      - tat
      - uig
    allophone_languages:
      - afr
      - amh
      - ara
      - aze
      - ben
      - bul
      - cat
      - ceb
      - ces
      - cmn
      - dan
      - deu
      - ell
      - eng
      - est
      - eus
      - fin
      - fra
      - ful
      - gle
      - glg
      - hau
      - hin
      - hrv
      - hun
      - ind
      - isl
      - ita
      - jav
      - jpn
      - kat
      - kin
      - kir
      - kor
      - lao
      - lit
      - mkd
      - mlt
      - mon
      - mri
      - msa
      - mya
      - nld
      - nob
      - pan
      - pol
      - por
      - ron
      - rus
      - sin
      - skr
      - slk
      - slv
      - sna
      - snd
      - som
      - spa
      - swa
      - swe
      - tam
      - tel
      - tha
      - tur
      - ukr
      - vie
      - xho
      - yor
      - yue
      - zul


model_conf:
    frontend_gradients: true
    extract_feats_in_collect_stats: false
    ctc_weight: 1.0
    interctc_weight: 0.5
    lsm_weight: 0.1
    length_normalized_loss: false
    aux_ctc_share_vocab: "dump/raw/train_allophant_mapped/feature_values.json"
    aux_ctc:
      '0':
        - advancedTongueRoot
        - anterior
        - approximant
        - back
        - click
        - consonantal
        - constrictedGlottis
        - continuant
        - coronal
        - delayedRelease
        - distributed
        - dorsal
        - epilaryngealSource
        - fortis
        - front
        - high
        - labial
        - labiodental
        - lateral
        - low
        - loweredLarynxImplosive
        - nasal
        - periodicGlottalSource
        - raisedLarynxEjective
        - retractedTongueRoot
        - round
        - short
        - sonorant
        - spreadGlottis
        - stress
        - strident
        - syllabic
        - tap
        - tense
        - trill
        - long

aux_ctc_tasks: ["advancedTongueRoot" , "anterior" , "approximant" , "back" , "click" , "consonantal" , "constrictedGlottis" , "continuant" , "coronal" , "delayedRelease" , "distributed" , "dorsal" , "epilaryngealSource" , "fortis" , "front" , "high" , "labial" , "labiodental" , "lateral" , "low" , "loweredLarynxImplosive" , "nasal" , "periodicGlottalSource" , "raisedLarynxEjective" , "retractedTongueRoot" , "round" , "short" , "sonorant" , "spreadGlottis" , "stress" , "strident" , "syllabic" , "tap" , "tense" , "trill" , "long"]

log_interval: 1
num_att_plot: 0
num_workers: 32
sort_in_batch: descending
sort_batch: descending
batch_type: numel
batch_bins: 4500000
accum_grad: 4
max_epoch: 45
patience: none
init: xavier_uniform
best_model_criterion:
-   - valid
    - loss_ctc
    - min
-   - valid
    - total_count
    - max
unused_parameters: true
keep_nbest_models: 10

use_amp: true
cudnn_deterministic: false
cudnn_benchmark: false

optim: adamw
optim_conf:
    lr: 0.0003
    weight_decay: 0.000001
    betas:
    - 0.9
    - 0.98
    eps: 1.0e-06
scheduler: warmuplr
scheduler_conf:
    warmup_steps: 625 # 2500

ctc_conf:
    zero_infinity: true
    elementwise_affine: false
